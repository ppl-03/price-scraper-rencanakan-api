{% extends 'dashboard/base_with_sidebar.html' %}

{% block title %}HSPK Upah Pemerintah â€“ Rencanakan{% endblock %}

{% block extra_css %}
  <style>
    /* Clean white design */
    body { 
      background: #fff; 
      color: #333; 
    }

    /* Content wrapper */
    .content-wrapper { 
      padding: 2rem;
    }

    .card{ border:none; border-radius:14px; box-shadow:0 2px 10px rgba(0,0,0,.06); }

    /* Search and filter controls */
    .search-section {
      background: white;
      border-radius: 14px;
      padding: 1.5rem;
      margin-bottom: 1.5rem;
      box-shadow: 0 2px 10px rgba(0,0,0,.06);
    }

    /* Table styling */
    .table-container {
      background: white;
      border-radius: 14px;
      overflow: hidden;
      box-shadow: 0 2px 10px rgba(0,0,0,.06);
    }
    
    .table thead{ background:#f8f9fa; border-bottom:2px solid #e9ecef; }
    .table th{ 
      border:none; 
      color:#495057; 
      font-weight:600; 
      user-select:none; 
      cursor:pointer; 
      padding: 1rem 0.75rem;
      font-size: 0.875rem;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    .table td{ 
      vertical-align: middle; 
      border-color:#f1f3f5; 
      padding: 0.875rem 0.75rem;
    }

    /* Sort indicators */
    .th-sort { position:relative; padding-right:24px; }
    .th-sort::after {
      content:"â†•"; 
      position:absolute; 
      right:8px; 
      top:50%; 
      transform:translateY(-50%); 
      font-size:0.875rem; 
      opacity:.4;
      transition: opacity 0.2s;
    }
    .th-sort:hover::after { opacity: 0.8; }
    .th-sort.asc::after { content:"â†‘"; opacity:.9; color: #0056b3; }
    .th-sort.desc::after { content:"â†“"; opacity:.9; color: #0056b3; }

    /* Primary button styling */
    .btn-brand { background:#00365a; border-color:#00365a; color:#fff; }
    .btn-brand:hover, .btn-brand:focus { background:#022b47; border-color:#022b47; color:#fff; }
    .btn-pill{ border-radius:999px; padding:10px 20px; font-weight:600; }

    /* Price alignment */
    .price-align-right { text-align: right !important; }

    /* Row hover effect */
    .table-hover tbody tr:hover {
      background-color: #f8f9fc;
      transform: scale(1.001);
      transition: all 0.2s ease;
    }

    /* Pagination styling */
    .pagination { 
      justify-content:center; 
      margin-top:1.5rem; 
      gap:8px; 
    }
    .page-link {
      border-radius:50%!important; 
      width:40px; 
      height:40px;
      display:flex; 
      align-items:center; 
      justify-content:center;
      color:#00365a; 
      border:2px solid #e9ecef; 
      background:#fff;
      font-weight: 600;
      transition: all 0.2s ease;
    }
    .page-item.active .page-link { 
      background:#00365a; 
      color:#fff; 
      border-color: #00365a;
      transform: scale(1.1);
    }
    .page-item .page-link:hover { 
      background:#f8f9fc; 
      color:#00365a; 
      border-color: #00365a;
      transform: translateY(-2px);
    }

    /* Status indicators */
    .status-badge {
      padding: 0.375rem 0.75rem;
      border-radius: 50px;
      font-size: 0.75rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    .status-active { background: #d4edda; color: #155724; }
    .status-updated { background: #d1ecf1; color: #0c5460; }

    /* Loading states */
    .loading-spinner {
      display: none;
      text-align: center;
      padding: 3rem;
    }
    .spinner-border-custom {
      width: 3rem;
      height: 3rem;
      border-width: 0.3em;
    }

    /* Empty state */
    .empty-state {
      text-align: center;
      padding: 3rem 1rem;
      color: #6c757d;
    }
    .empty-state-icon {
      font-size: 3rem;
      margin-bottom: 1rem;
      opacity: 0.5;
    }

    /* Results info */
    .results-info {
      color: #6c757d;
      font-size: 0.9rem;
      margin-bottom: 1rem;
    }

    /* Mobile responsiveness */
    @media (max-width: 768px) {
      .table-responsive {
        border-radius: 14px;
      }
    }

    /* Region selector */
    .region-selector {
      background: #e3f2fd;
      border-radius: 10px;
      padding: 1rem;
      margin-bottom: 1.5rem;
      border-left: 4px solid #2196f3;
    }
  </style>
{% endblock %}

{% block content %}
  <div class="content-wrapper">
    <!-- Region Selection -->
    <div class="region-selector">
      <div class="row align-items-center">
        <div class="col-md-8">
          <h6 class="mb-2"><i class="fas fa-map-marker-alt me-2"></i>Wilayah Terpilih</h6>
          <p class="mb-0">Data HSPK <strong>Tahun 2025</strong> untuk <strong>Kabupaten Cilacap</strong> - Provinsi Jawa Tengah</p>
        </div>
        <div class="col-md-4 text-md-end">
          <button class="btn btn-outline-primary btn-sm" data-bs-toggle="modal" data-bs-target="#regionModal">
            <i class="fas fa-edit me-1"></i> Ganti Wilayah
          </button>
        </div>
      </div>
    </div>

    <!-- Search and Filter Section -->
    <div class="search-section">
      <h6 class="mb-3"><i class="fas fa-search me-2"></i>Pencarian & Filter</h6>
      <div class="row g-3">
        <div class="col-md-6">
          <label for="searchInput" class="form-label">Cari Uraian Pekerjaan</label>
          <div class="input-group">
            <span class="input-group-text"><i class="fas fa-search"></i></span>
            <input type="text" id="searchInput" class="form-control" 
                   placeholder="Masukkan kata kunci (misal: pondasi, batu, mortar...)">
          </div>
        </div>
        <div class="col-md-3">
          <label for="categoryFilter" class="form-label">Kategori</label>
          <select id="categoryFilter" class="form-select">
            <option value="">Semua Kategori</option>
            <option value="pondasi">Pondasi</option>
            <option value="bekisting">Bekisting</option>
            <option value="batu">Batu & Mortar</option>
            <option value="plat">Plat & Lantai</option>
            <option value="dinding">Dinding</option>
          </select>
        </div>
        <div class="col-md-3">
          <label for="priceRange" class="form-label">Range Harga</label>
          <select id="priceRange" class="form-select">
            <option value="">Semua Harga</option>
            <option value="0-500000">< Rp 500.000</option>
            <option value="500000-1000000">Rp 500.000 - 1 Juta</option>
            <option value="1000000-2000000">Rp 1 Juta - 2 Juta</option>
            <option value="2000000-">> Rp 2 Juta</option>
          </select>
        </div>
      </div>
    </div>
    <!-- Results Info -->
    <div class="mb-3">
      <div class="results-info">
        <span id="resultsCount">Menampilkan 1 sampai 10 dari 387 entri</span>
      </div>
    </div>
    <!-- Loading Spinner -->
    <div id="loadingSpinner" class="loading-spinner">
      <div class="spinner-border spinner-border-custom text-primary">
        <output class="visually-hidden">Loading...</output>
      </div>
      <p class="mt-3">Memuat data HSPK...</p>
    </div>
    <!-- Data Table -->
    <div id="dataTable" class="table-container">
      <div class="table-responsive">
        <table class="table table-hover mb-0">
          <thead>
            <tr>
              <th scope="col" class="th-sort" data-sort="no">No.</th>
              <th scope="col" class="th-sort" data-sort="kode">Kode</th>
              <th scope="col" class="th-sort" data-sort="uraian">Uraian Pekerjaan</th>
              <th scope="col" class="th-sort text-center" data-sort="satuan">Satuan</th>
              <th scope="col" class="th-sort price-align-right" data-sort="harga">Harga Satuan (Rp)</th>
            </tr>
          </thead>
          <tbody id="tableBody">
            <!-- Data will be loaded dynamically via JavaScript -->
          </tbody>
        </table>
      </div>
      <!-- Pagination -->
      <div class="p-3">
        <nav aria-label="Page navigation">
          <ul class="pagination" id="pagination">
            <li class="page-item">
              <a class="page-link" href="#" aria-label="Previous">
                <i class="fas fa-chevron-left"></i>
              </a>
            </li>
            <li class="page-item active"><a class="page-link" href="#">1</a></li>
            <li class="page-item"><a class="page-link" href="#">2</a></li>
            <li class="page-item"><a class="page-link" href="#">3</a></li>
            <li class="page-item"><a class="page-link" href="#">4</a></li>
            <li class="page-item"><a class="page-link" href="#">5</a></li>
            <li class="page-item disabled"><a class="page-link" href="#">...</a></li>
            <li class="page-item"><a class="page-link" href="#">39</a></li>
            <li class="page-item">
              <a class="page-link" href="#" aria-label="Next">
                <i class="fas fa-chevron-right"></i>
              </a>
            </li>
          </ul>
        </nav>
      </div>
    </div>
    <!-- Empty State (hidden by default) -->
    <div id="emptyState" class="empty-state" style="display: none;">
      <div class="empty-state-icon">
        <i class="fas fa-search"></i>
      </div>
      <h5>Tidak ada data ditemukan</h5>
      <p>Coba ubah filter pencarian atau kata kunci yang digunakan</p>
    </div>

    <!-- Footer -->
    <div class="mt-5 pt-4 border-top text-center text-muted">
      <p>&copy; 2025 Rencanakan. Data HSPK berdasarkan sumber resmi pemerintah.</p>
    </div>
  </div>
  <!-- Region Selection Modal -->
  <div class="modal fade" id="regionModal" tabindex="-1" aria-labelledby="regionModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="regionModalLabel">
            <i class="fas fa-map-marker-alt me-2"></i>Pilih Wilayah
          </h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="row g-3">
            <div class="col-md-6">
              <label for="provinceSelect" class="form-label">Provinsi</label>
              <select id="provinceSelect" class="form-select">
                <option value="">Pilih Provinsi</option>
                <option value="jawa-tengah" selected>Jawa Tengah</option>
                <option value="jawa-barat">Jawa Barat</option>
                <option value="jawa-timur">Jawa Timur</option>
                <!-- Add more provinces -->
              </select>
            </div>
            <div class="col-md-6">
              <label for="regencySelect" class="form-label">Kabupaten/Kota</label>
              <select id="regencySelect" class="form-select">
                <option value="">Pilih Kabupaten/Kota</option>
                <option value="cilacap" selected>Kabupaten Cilacap</option>
                <option value="banyumas">Kabupaten Banyumas</option>
                <option value="purbalingga">Kabupaten Purbalingga</option>
                <!-- Add more regencies -->
              </select>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Batal</button>
          <button type="button" class="btn btn-brand" onclick="changeRegion()">Terapkan Perubahan</button>
        </div>
      </div>
    </div>
  </div>
{% endblock %}

{% block extra_js %}
  <script>
    // Global variables
    let currentData = [];
    let allData = [];
    let currentSort = { field: '', direction: '' };
    let currentFilters = {
      region: 'Kab. Cilacap',
      year: '2025',
      search: '',
      category: '',
      price_range: ''
    };
    let currentPage = 1;
    let totalPages = 1;
    let isLoading = false;

    // API Functions
    async function fetchWageData() {
      if (isLoading) {
        console.log('Already loading, skipping request');
        return;
      }
      
      isLoading = true;
      showLoading(true);
      
      console.log('=== Fetching Wage Data ===');
      console.log('Filters:', currentFilters);
      
      try {
        // Build query parameters for the 2025 API
        // Request ALL data for client-side filtering
        const params = new URLSearchParams({
          region: currentFilters.region,
          year: currentFilters.year,
          all: 'true'  // Get all data for client-side filtering
        });
        
        // Add force_refresh parameter if needed
        if (currentFilters.force_refresh) {
          params.append('force_refresh', 'true');
        }
        
        const url = `/api/gov-wage/data/?${params}`;
        console.log('Fetching from URL:', url);
        
        const response = await fetch(url);
        console.log('Response status:', response.status);
        console.log('Response headers:', response.headers);
        
        const data = await response.json();
        console.log('Response data:', data);
        
        if (data.success) {
          // Store ALL data WITHOUT filtering - this is the complete dataset
          allData = data.data;
          console.log('Stored allData:', allData.length, 'items');
          
          // NOW apply client-side filters and sorting
          let filteredData = applyClientFilters(allData);
          filteredData = applyClientSort(filteredData);
          
          // Calculate pagination from filtered data
          const totalItems = filteredData.length;
          totalPages = Math.ceil(totalItems / 10) || 1;
          const startIndex = (currentPage - 1) * 10;
          const endIndex = startIndex + 10;
          currentData = filteredData.slice(startIndex, endIndex);
          
          console.log('After filtering - showing', currentData.length, 'items on page', currentPage);
          
          // Update UI
          updatePagination({
            current_page: currentPage,
            total_pages: totalPages,
            total_items: totalItems,
            per_page: 10,
            has_next: currentPage < totalPages,
            has_previous: currentPage > 1
          });
          renderTable();
          updateResultsCount({
            current_page: currentPage,
            total_items: totalItems,
            per_page: 10
          });
          
          // Show cache status in console
          if (data.data_load_time_ms) {
            console.log(`Data loaded in ${data.data_load_time_ms}ms (${data.cached ? 'from cache' : 'fresh'})`);
          }
        } else {
          console.error('API Error:', data.error);
          showError(data.error || 'Gagal mengambil data HSPK');
        }
      } catch (error) {
        console.error('Error fetching wage data:', error);
        showError('Terjadi kesalahan saat mengambil data: ' + error.message);
      } finally {
        isLoading = false;
        showLoading(false);
      }
    }
    
    // Client-side filtering
    function applyClientFilters(data) {
      let filtered = data;
      
      console.log('â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
      console.log('â•‘ APPLY CLIENT FILTERS');
      console.log('â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
      console.log('â•‘ Input data count:', data.length);
      console.log('â•‘ Current filters:', JSON.stringify(currentFilters, null, 2));
      
      // Search filter
      if (currentFilters.search && currentFilters.search.trim().length > 0) {
        const searchLower = currentFilters.search.toLowerCase().trim();
        console.log('â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
        console.log('â•‘ ðŸ” SEARCH FILTER ACTIVE');
        console.log('â•‘ Search term:', `"${searchLower}"`);
        console.log('â•‘ Before filter:', filtered.length, 'items');
        
        filtered = filtered.filter(item => {
          const description = (item.work_description || '').toLowerCase();
          const code = (item.work_code || '').toLowerCase();
          const matches = description.includes(searchLower) || code.includes(searchLower);
          
          if (matches) {
            console.log('â•‘   âœ“ Match:', item.work_code, '-', item.work_description.substring(0, 40));
          }
          
          return matches;
        });
        
        console.log('â•‘ After search filter:', filtered.length, 'items');
      } else {
        console.log('â•‘ â„¹ï¸  No search filter (empty or whitespace)');
      }
      
      // Category filter
      if (currentFilters.category) {
        console.log('â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
        console.log('â•‘ ðŸ“ CATEGORY FILTER ACTIVE');
        console.log('â•‘ Category:', currentFilters.category);
        console.log('â•‘ Before filter:', filtered.length, 'items');
        filtered = filtered.filter(item => item.category === currentFilters.category);
        console.log('â•‘ After category filter:', filtered.length, 'items');
      }
      
      // Price range filter
      if (currentFilters.price_range) {
        const [min, max] = parsePriceRange(currentFilters.price_range);
        console.log('â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
        console.log('â•‘ ðŸ’° PRICE FILTER ACTIVE');
        console.log('â•‘ Price range:', min, '-', max);
        console.log('â•‘ Before filter:', filtered.length, 'items');
        filtered = filtered.filter(item => {
          const price = item.unit_price_idr || 0;
          return price >= min && (max === Infinity || price <= max);
        });
        console.log('â•‘ After price filter:', filtered.length, 'items');
      }
      
      console.log('â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
      console.log('â•‘ âœ… FINAL RESULT:', filtered.length, 'items');
      console.log('â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n');
      return filtered;
    }
    
    // Client-side sorting
    function applyClientSort(data) {
      if (!currentSort.field) return data;
      
      return [...data].sort((a, b) => {
        let aVal = a[currentSort.field];
        let bVal = b[currentSort.field];
        
        // Handle numeric fields
        if (currentSort.field === 'unit_price_idr' || currentSort.field === 'item_number') {
          aVal = parseFloat(aVal) || 0;
          bVal = parseFloat(bVal) || 0;
        } else {
          // String comparison
          aVal = String(aVal || '').toLowerCase();
          bVal = String(bVal || '').toLowerCase();
        }
        
        if (aVal < bVal) return currentSort.direction === 'asc' ? -1 : 1;
        if (aVal > bVal) return currentSort.direction === 'asc' ? 1 : -1;
        return 0;
      });
    }
    
    // Parse price range string
    function parsePriceRange(range) {
      if (range === '0-500000') return [0, 500000];
      if (range === '500000-1000000') return [500000, 1000000];
      if (range === '1000000-2000000') return [1000000, 2000000];
      if (range === '2000000-') return [2000000, Infinity];
      
      const parts = range.split('-');
      const min = parseInt(parts[0]) || 0;
      const max = parts[1] ? parseInt(parts[1]) : Infinity;
      return [min, max];
    }

    async function fetchAvailableRegions() {
      try {
        const response = await fetch('/api/gov-wage/regions/');
        const data = await response.json();
        
        if (data.success) {
          updateRegionSelect(data.regions);
        }
      } catch (error) {
        console.error('Error fetching regions:', error);
      }
    }

    async function fetchPaginationInfo(region) {
      try {
        const params = new URLSearchParams({
          region: region,
          year: currentFilters.year
        });
        
        const response = await fetch(`/api/gov-wage/pagination/?${params}`);
        const data = await response.json();
        
        if (data.success) {
          // Update global pagination info
          totalPages = data.total_pages;
          console.log(`Pagination info for ${region}: ${data.total_items} items, ${data.total_pages} pages`);
        }
      } catch (error) {
        console.error('Error fetching pagination info:', error);
      }
    }

    // Format currency
    function formatCurrency(amount) {
      return new Intl.NumberFormat('id-ID', {
        style: 'currency',
        currency: 'IDR',
        minimumFractionDigits: 0,
        maximumFractionDigits: 0
      }).format(amount).replace('IDR', 'Rp') + ',-';
    }

    // Event Listeners
    document.getElementById('searchInput').addEventListener('input', debounce(function(event) {
      const searchValue = this.value;
      currentFilters.search = searchValue;
      currentPage = 1;
      
      console.log('â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
      console.log('â•‘ SEARCH EVENT TRIGGERED');
      console.log('â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
      console.log('â•‘ Search input value:', `"${searchValue}"`);
      console.log('â•‘ Search length:', searchValue.length);
      console.log('â•‘ allData available:', allData.length, 'items');
      console.log('â•‘ currentFilters:', JSON.stringify(currentFilters, null, 2));
      console.log('â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
      
      if (allData.length === 0) {
        console.error('âŒ ERROR: allData is empty! Cannot filter.');
        return;
      }
      
      // Log first 3 items to verify data
      console.log('First 3 items in allData:');
      allData.slice(0, 3).forEach((item, idx) => {
        console.log(`  ${idx + 1}. ${item.work_code} - ${item.work_description.substring(0, 60)}...`);
      });
      
      // Client-side filtering without API call
      console.log('ðŸ” Calling applyClientFilters...');
      let filteredData = applyClientFilters(allData);
      console.log('âœ“ Filtered results:', filteredData.length, 'items');
      
      if (filteredData.length > 0) {
        console.log('Filtered items:');
        filteredData.slice(0, 5).forEach((item, idx) => {
          console.log(`  ${idx + 1}. ${item.work_code} - ${item.work_description.substring(0, 60)}...`);
        });
      }
      
      filteredData = applyClientSort(filteredData);
      
      const totalItems = filteredData.length;
      totalPages = Math.ceil(totalItems / 10) || 1;
      currentData = filteredData.slice(0, 10);
      
      console.log('ðŸ“„ Displaying:', currentData.length, 'items on page 1');
      console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n');
      
      updatePagination({
        current_page: 1,
        total_pages: totalPages,
        total_items: totalItems,
        per_page: 10,
        has_next: totalPages > 1,
        has_previous: false
      });
      renderTable();
      updateResultsCount({
        current_page: 1,
        total_items: totalItems,
        per_page: 10
      });
    }, 300));

    document.getElementById('categoryFilter').addEventListener('change', function() {
      currentFilters.category = this.value;
      currentPage = 1;
      
      console.log('Category filter:', this.value);
      
      // Client-side filtering without API call
      let filteredData = applyClientFilters(allData);
      console.log('Filtered results:', filteredData.length, 'items');
      
      filteredData = applyClientSort(filteredData);
      
      const totalItems = filteredData.length;
      totalPages = Math.ceil(totalItems / 10) || 1;
      currentData = filteredData.slice(0, 10);
      
      updatePagination({
        current_page: 1,
        total_pages: totalPages,
        total_items: totalItems,
        per_page: 10,
        has_next: totalPages > 1,
        has_previous: false
      });
      renderTable();
      updateResultsCount({
        current_page: 1,
        total_items: totalItems,
        per_page: 10
      });
    });

    document.getElementById('priceRange').addEventListener('change', function() {
      currentFilters.price_range = this.value;
      currentPage = 1;
      
      console.log('Price range filter:', this.value);
      
      // Client-side filtering without API call
      let filteredData = applyClientFilters(allData);
      console.log('Filtered results:', filteredData.length, 'items');
      
      filteredData = applyClientSort(filteredData);
      
      const totalItems = filteredData.length;
      totalPages = Math.ceil(totalItems / 10) || 1;
      currentData = filteredData.slice(0, 10);
      
      updatePagination({
        current_page: 1,
        total_pages: totalPages,
        total_items: totalItems,
        per_page: 10,
        has_next: totalPages > 1,
        has_previous: false
      });
      renderTable();
      updateResultsCount({
        current_page: 1,
        total_items: totalItems,
        per_page: 10
      });
    });

    // Debounce function for search
    function debounce(func, wait) {
      let timeout;
      return function executedFunction(...args) {
        const context = this;
        const later = () => {
          clearTimeout(timeout);
          func.apply(context, args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
      };
    }

    // UI Functions
    function renderTable() {
      const tableBody = document.getElementById('tableBody');
      const dataTable = document.getElementById('dataTable');
      const emptyState = document.getElementById('emptyState');

      console.log('Rendering table with', currentData.length, 'items');

      if (currentData.length === 0) {
        console.log('No data to display - showing empty state');
        dataTable.style.display = 'none';
        emptyState.style.display = 'block';
        
        // Reset empty state to default (not error)
        emptyState.innerHTML = `
          <div class="empty-state-icon">
            <i class="fas fa-search"></i>
          </div>
          <h5>Tidak ada data ditemukan</h5>
          <p>Coba ubah filter pencarian atau kata kunci yang digunakan</p>
        `;
        return;
      }

      dataTable.style.display = 'block';
      emptyState.style.display = 'none';

      tableBody.innerHTML = currentData.map((item, index) => `
        <tr>
          <td>${item.item_number || ((currentPage - 1) * 10 + index + 1)}</td>
          <td>${item.work_code || '-'}</td>
          <td>${item.work_description || '-'}</td>
          <td class="text-center">${item.unit || '-'}</td>
          <td class="price-align-right">${formatCurrency(item.unit_price_idr || 0)}</td>
        </tr>
      `).join('');
    }

    function updateResultsCount(pagination) {
      const resultsCount = document.getElementById('resultsCount');
      if (pagination) {
        if (pagination.total_items === 0) {
          resultsCount.textContent = 'Tidak ada data yang ditemukan';
        } else {
          const start = ((pagination.current_page - 1) * pagination.per_page) + 1;
          const end = Math.min(start + pagination.per_page - 1, pagination.total_items);
          resultsCount.textContent = `Menampilkan ${start} sampai ${end} dari ${pagination.total_items} entri`;
        }
      } else {
        resultsCount.textContent = 'Memuat data...';
      }
    }

    function updatePagination(pagination) {
      currentPage = pagination.current_page;
      totalPages = pagination.total_pages;
      
      const paginationEl = document.getElementById('pagination');
      let paginationHTML = '';
      
      // Previous button
      if (pagination.has_previous) {
        paginationHTML += `
          <li class="page-item">
            <a class="page-link" href="#" onclick="changePage(${currentPage - 1})" aria-label="Previous">
              <i class="fas fa-chevron-left"></i>
            </a>
          </li>
        `;
      }
      
      // Page numbers
      const startPage = Math.max(1, currentPage - 2);
      const endPage = Math.min(totalPages, currentPage + 2);
      
      for (let i = startPage; i <= endPage; i++) {
        paginationHTML += `
          <li class="page-item ${i === currentPage ? 'active' : ''}">
            <a class="page-link" href="#" onclick="changePage(${i})">${i}</a>
          </li>
        `;
      }
      
      // Show dots and last page if needed
      if (endPage < totalPages) {
        if (endPage < totalPages - 1) {
          paginationHTML += `<li class="page-item disabled"><a class="page-link" href="#">...</a></li>`;
        }
        paginationHTML += `
          <li class="page-item">
            <a class="page-link" href="#" onclick="changePage(${totalPages})">${totalPages}</a>
          </li>
        `;
      }
      
      // Next button
      if (pagination.has_next) {
        paginationHTML += `
          <li class="page-item">
            <a class="page-link" href="#" onclick="changePage(${currentPage + 1})" aria-label="Next">
              <i class="fas fa-chevron-right"></i>
            </a>
          </li>
        `;
      }
      
      paginationEl.innerHTML = paginationHTML;
    }

    function changePage(page) {
      if (page !== currentPage && page >= 1 && page <= totalPages) {
        currentPage = page;
        
        // Client-side pagination
        let filteredData = applyClientFilters(allData);
        filteredData = applyClientSort(filteredData);
        
        const totalItems = filteredData.length;
        const startIndex = (page - 1) * 10;
        const endIndex = startIndex + 10;
        currentData = filteredData.slice(startIndex, endIndex);
        
        updatePagination({
          current_page: page,
          total_pages: totalPages,
          total_items: totalItems,
          per_page: 10,
          has_next: page < totalPages,
          has_previous: page > 1
        });
        renderTable();
        updateResultsCount({
          current_page: page,
          total_items: totalItems,
          per_page: 10
        });
        
        // Scroll to top
        window.scrollTo({ top: 0, behavior: 'smooth' });
      }
    }

    function showLoading(show) {
      const loadingSpinner = document.getElementById('loadingSpinner');
      const dataTable = document.getElementById('dataTable');
      
      if (show) {
        loadingSpinner.style.display = 'block';
        dataTable.style.display = 'none';
      } else {
        loadingSpinner.style.display = 'none';
        dataTable.style.display = 'block';
      }
    }

    function showError(message) {
      // Create a better error display
      const emptyState = document.getElementById('emptyState');
      const dataTable = document.getElementById('dataTable');
      
      dataTable.style.display = 'none';
      emptyState.style.display = 'block';
      emptyState.innerHTML = `
        <div class="empty-state-icon" style="color: #dc3545;">
          <i class="fas fa-exclamation-triangle"></i>
        </div>
        <h5 style="color: #dc3545;">Error</h5>
        <p>${message}</p>
        <button class="btn btn-primary mt-3" onclick="location.reload()">
          <i class="fas fa-redo me-2"></i>Muat Ulang Halaman
        </button>
      `;
      
      // Also log to console
      console.error('Application Error:', message);
    }

    function updateRegionSelect(regions) {
      const provinceSelect = document.getElementById('provinceSelect');
      
      // Group regions by province
      const provinceGroups = {};
      for (const region of regions) {
        if (!provinceGroups[region.province]) {
          provinceGroups[region.province] = [];
        }
        provinceGroups[region.province].push(region);
      }
      
      // Update province select
      provinceSelect.innerHTML = '<option value="">Pilih Provinsi</option>';
      for (const province of Object.keys(provinceGroups)) {
        const option = document.createElement('option');
        option.value = province;
        option.textContent = province;
        if (province === 'Jawa Tengah') option.selected = true;
        provinceSelect.appendChild(option);
      }
      
      // Update regency select for Jawa Tengah (default)
      if (provinceGroups['Jawa Tengah']) {
        updateRegencySelect(provinceGroups['Jawa Tengah']);
      }
    }

    function updateRegencySelect(regencies) {
      const regencySelectEl = document.getElementById('regencySelect');
      regencySelectEl.innerHTML = '<option value="">Pilih Kabupaten/Kota</option>';
      
      for (const regency of regencies) {
        const option = document.createElement('option');
        option.value = regency.value;
        option.textContent = regency.name;
        if (regency.value === 'Kab. Cilacap') option.selected = true;
        regencySelectEl.appendChild(option);
      }
    }

    // Sort functionality
    for (const header of document.querySelectorAll('.th-sort')) {
      header.addEventListener('click', function() {
        const field = this.dataset.sort;
        
        // Map frontend field names to data field names
        const fieldMap = {
          'no': 'item_number',
          'kode': 'work_code',
          'uraian': 'work_description',
          'satuan': 'unit',
          'harga': 'unit_price_idr'
        };
        
        const dataField = fieldMap[field] || field;
        
        // Remove sort classes from all headers
        for (const h of document.querySelectorAll('.th-sort')) {
          h.classList.remove('asc', 'desc');
        }

        // Determine sort direction
        if (currentSort.field === dataField && currentSort.direction === 'asc') {
          currentSort.direction = 'desc';
          this.classList.add('desc');
        } else {
          currentSort.direction = 'asc';
          this.classList.add('asc');
        }
        currentSort.field = dataField;
        
        // Apply client-side sorting
        currentPage = 1;
        let filteredData = applyClientFilters(allData);
        filteredData = applyClientSort(filteredData);
        
        const totalItems = filteredData.length;
        totalPages = Math.ceil(totalItems / 10);
        currentData = filteredData.slice(0, 10);
        
        updatePagination({
          current_page: 1,
          total_pages: totalPages,
          total_items: totalItems,
          per_page: 10,
          has_next: totalPages > 1,
          has_previous: false
        });
        renderTable();
        updateResultsCount({
          current_page: 1,
          total_items: totalItems,
          per_page: 10
        });
      });
    }

    // Change region
    function changeRegion() {
      const regency = document.getElementById('regencySelect').value;
      
      if (!regency) {
        alert('Silakan pilih kabupaten/kota terlebih dahulu');
        return;
      }
      
      // Update current region filter
      currentFilters.region = regency;
      currentPage = 1;
      
      // Update display - find the paragraph with region info
      const regionText = document.querySelector('.region-selector p');
      const regencyName = document.querySelector(`#regencySelect option[value="${regency}"]`).textContent;
      regionText.innerHTML = `Data HSPK <strong>Tahun ${currentFilters.year}</strong> untuk <strong>${regencyName}</strong> - Provinsi Jawa Tengah`;
      
      // Close modal
      const modal = bootstrap.Modal.getInstance(document.getElementById('regionModal'));
      modal.hide();
      
      // Fetch new data for the region
      fetchWageData();
    }

    // Province change handler
    document.getElementById('provinceSelect').addEventListener('change', function() {
      const province = this.value;
      // In a real implementation, you would fetch regencies for the selected province
      // For now, we only support Central Java
      if (province === 'Jawa Tengah') {
        fetchAvailableRegions();
      }
    });

    // Initialize
    document.addEventListener('DOMContentLoaded', function() {
      console.log('=== Gov Wage Page Initialized ===');
      console.log('Current filters:', currentFilters);
      console.log('Starting to fetch wage data...');
      
      // Load initial data
      fetchWageData();
      fetchAvailableRegions();

      // Set up initial display
      updateResultsCount();
      
      console.log('Gov Wage Dashboard initialized with 2025 JSON caching system');
    });
  </script>
{% endblock %}