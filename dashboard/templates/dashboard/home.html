<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8">
  <title>Harga Satuan – Rencanakan</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  {% load static %}
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body { background:#f7f9fb; font-family: Arial, sans-serif; color:#333; }

    /* Top bar with only the logo + avatar */
    .topbar { background:#fff; }
    .brand-wrap { display:flex; align-items:center; gap:12px; }
    .brand-logo { height:36px; width:auto; }
    .avatar { width:32px; height:32px; border-radius:50%; object-fit:cover; }

    .content-wrapper{ margin-top:24px; }
    .card{ border:none; border-radius:14px; box-shadow:0 2px 10px rgba(0,0,0,.06); }

    .table thead{ background:#fff; border-bottom:2px solid #e9ecef; }
    .table th{ border:none; color:#444; font-weight:600; user-select:none; cursor:pointer; }
    .table td{ vertical-align: middle; border-color:#f1f3f5; }

    /* Sort indicators */
    .th-sort { position:relative; padding-right:18px; }
    .th-sort::after {
      content:"↕"; position:absolute; right:6px; top:50%; transform:translateY(-50%); font-size:.9rem; opacity:.35;
    }
    .th-sort.asc::after { content:"↑"; opacity:.9; }
    .th-sort.desc::after { content:"↓"; opacity:.9; }

    /* Primary button color = #00365a */
    .btn-brand { background:#00365a; border-color:#00365a; color:#fff; }
    .btn-brand:hover, .btn-brand:focus { background:#022b47; border-color:#022b47; color:#fff; }
    .btn-pill{ border-radius:999px; padding:10px 20px; font-weight:600; }

    /* Oval warning */
    .alert-vendor {
      background:#c6d1d8; color:#00365a;
      border-radius:50px; padding:10px 18px; font-size:.95rem; margin-bottom:1rem; border:1px solid #b7c3cb;
    }
    .alert-vendor strong { font-weight:700; }

    /* Inline loading (inside results card) */
    .loading-inline { display:none; min-height:200px; place-items:center; padding:24px; }
    .loading-panel{
      background:#fff; border-radius:16px; box-shadow:0 6px 20px rgba(0,0,0,.10);
      padding:18px 22px; display:flex; align-items:center; gap:12px; border:1px solid #eef2f6;
    }
    .ring { width:26px; height:26px; border:3px solid #e9eef5; border-top-color:#0d6efd; border-radius:50%; animation:spin .9s linear infinite; }
    @keyframes spin { to { transform:rotate(360deg) } }

    /* Controls row (filters like DataTables) */
    .controls { gap:8px; }
    .controls .form-control, .controls .form-select { background:#fff; }

    /* Pagination circles */
    .pagination { justify-content:center; margin-top:20px; gap:8px; }
    .page-link {
      border-radius:50%!important; width:36px; height:36px;
      display:flex; align-items:center; justify-content:center;
      color:#00365a; border:none; background:#eef3f6;
    }
    .page-item.active .page-link { background:#00365a; color:#fff; }
    .page-item .page-link:hover { background:#dfe7ec; color:#00365a; }

    .footer{ margin-top:40px; font-size:.85rem; color:#888; text-align:center; }
  </style>
</head>
<body>
  <!-- Top bar with logo only -->
  <header class="topbar py-3">
    <div class="container d-flex align-items-center justify-content-between">
      <div class="brand-wrap">
        <img class="brand-logo" src="{% static 'dashboard/images/rencanakan_logo.png' %}" alt="Rencanakan logo">
      </div>
      <div class="d-flex align-items-center gap-3">
        <img class="avatar" src="https://i.imgur.com/7k12rjS.png" alt="profile">
      </div>
    </div>
  </header>

  <div class="container content-wrapper">

    <!-- Oval warning banner ABOVE the search bar (only if messages exist) -->
    {% if messages %}
      <div id="alerts" class="mb-2">
        {% for m in messages %}
          {% if m.level_tag != 'info' %}
            <div class="alert-vendor js-vendor-msg" data-raw="{{ m|escape }}">
              <strong>Warning!</strong> {{ m }}
            </div>
          {% endif %}
        {% endfor %}
      </div>
    {% endif %}

    <!-- Backend search (hits your scrapers) -->
    <form id="searchForm" action="{% url 'home' %}" method="get" class="mb-3" novalidate>
      <div class="input-group">
        <input id="qInput" type="text" name="q" class="form-control"
               placeholder="Cari produk (contoh: semen, pasir, batu...)"
               value="{{ request.GET.q|default_if_none:'' }}" autocomplete="off">
        <button id="searchBtn" type="submit" class="btn btn-brand btn-pill d-inline-flex align-items-center gap-2">
          <span class="btn-text">Search</span>
          <span class="btn-spinner spinner-border spinner-border-sm" style="display:none" aria-hidden="true"></span>
        </button>
      </div>
    </form>

    <!-- Client-side DataTable-like controls -->
    <div class="d-flex flex-wrap controls mb-3">
      <div class="input-group" style="max-width:320px;">
        <span class="input-group-text">Filter hasil</span>
        <input id="filterInput" type="text" class="form-control" placeholder="ketik untuk memfilter…">
      </div>

      <div class="input-group" style="max-width:260px;">
        <span class="input-group-text">Vendor</span>
        <select id="vendorSelect" class="form-select">
          <option value="">Semua vendor</option>
        </select>
      </div>

      <div class="input-group" style="max-width:240px;">
        <span class="input-group-text">Harga min</span>
        <input id="minPrice" type="number" class="form-control" placeholder="0">
      </div>

      <div class="input-group" style="max-width:240px;">
        <span class="input-group-text">Harga max</span>
        <input id="maxPrice" type="number" class="form-control" placeholder="∞">
      </div>

      <button id="clearFilters" class="btn btn-outline-secondary btn-pill">Reset</button>
    </div>

    <!-- Results card -->
    <div class="card">
      <!-- Inline loading state -->
      <div id="loadingInline" class="loading-inline">
        <div class="loading-panel" role="status" aria-live="polite" aria-label="Mengambil harga">
          <div class="ring" aria-hidden="true"></div>
          <div>
            <div class="fw-semibold">Mengambil harga…</div>
            <div class="text-muted small">Mohon tunggu sebentar</div>
          </div>
        </div>
      </div>

      <!-- Table -->
      <div id="resultsWrap" class="card-body p-0">
        <table class="table table-hover mb-0" id="pricesTable">
          <thead>
            <tr>
              <th style="width:5%">No.</th>
              <th class="th-sort" data-key="item">Nama Produk</th>
              <th class="th-sort" data-key="price" style="width:20%">Harga</th>
              <th class="th-sort" data-key="vendor" style="width:25%">Vendor</th>
            </tr>
          </thead>
          <tbody id="tableBody">
            {% for r in prices %}
              <tr>
                <td>{{ forloop.counter }}</td>
                <td class="c-item">{{ r.item }}</td>
                <td class="c-price">{{ r.value }}</td>
                <td class="c-vendor">{{ r.source|default:"—" }}</td>
              </tr>
            {% empty %}
              <tr><td colspan="4" class="text-center text-muted py-4">Tidak ada data</td></tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>

    <!-- Pagination -->
    <nav aria-label="Hasil pencarian">
      <ul id="pagination" class="pagination"></ul>
    </nav>

    <div class="footer">© 2025 rencanakan.id</div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    // ---------- Price formatting: "IDR 30,400" (code, comma thousands, NO decimals) ----------
    // Use en-US locale + currencyDisplay: 'code' and 0 fraction digits
    const idf = new Intl.NumberFormat("en-US", {
      style: "currency",
      currency: "IDR",
      currencyDisplay: "code",
      minimumFractionDigits: 0,
      maximumFractionDigits: 0
    });

    // Format any server-rendered price cells immediately
    document.querySelectorAll(".c-price").forEach(td => {
      const raw = String(td.textContent || "").replace(/[^\d.-]/g, "");
      const num = Number(raw);
      if (Number.isFinite(num)) {
        td.textContent = idf.format(Math.round(num));
      }
    });

    // ---------- Friendly vendor error messages ----------
    function rewriteVendorMessage(raw) {
      const vendorMatch = raw.match(/\[([^\]]+)\]/);
      const vendor = vendorMatch ? vendorMatch[1].trim() : null;
      if (/HTTP error\s+(\d{3})/i.test(raw)) {
        const code = raw.match(/HTTP error\s+(\d{3})/i)[1];
        return `<strong>${vendor ?? 'Salah satu vendor'}</strong> sedang tidak tersedia (HTTP ${code}). Data dari vendor lain tetap ditampilkan. Coba lagi beberapa menit lagi.`;
      }
      if (/timeout|timed\s*out|connection.*(timed|time).*out/i.test(raw)) {
        return `<strong>${vendor ?? 'Salah satu vendor'}</strong> tidak merespons tepat waktu. Menampilkan hasil dari sumber lain sementara ini.`;
      }
      if (/captcha|blocked|forbid|403/i.test(raw)) {
        return `<strong>${vendor ?? 'Salah satu vendor'}</strong> membatasi akses otomatis saat ini. Kami akan mencoba lagi nanti.`;
      }
      if (/parse|selector|structure|changed/i.test(raw)) {
        return `Struktur halaman <strong>${vendor ?? 'vendor'}</strong> berubah, sehingga data tidak dapat diambil. Akan kami sesuaikan secepatnya.`;
      }
      return raw;
    }
    document.querySelectorAll(".js-vendor-msg").forEach(el => {
      const raw = el.getAttribute("data-raw") || el.textContent || "";
      el.innerHTML = rewriteVendorMessage(raw);
    });

    // ---------- Inline search loading ----------
    const form = document.getElementById("searchForm");
    const qInput = document.getElementById("qInput");
    const results = document.getElementById("resultsWrap");
    const loadingInline = document.getElementById("loadingInline");
    const btn = document.getElementById("searchBtn");
    const btnText = btn?.querySelector(".btn-text");
    const btnSpin = btn?.querySelector(".btn-spinner");

    function showInlineLoading() {
      if (results) results.style.display = "none";
      if (loadingInline) { loadingInline.style.display = "grid"; loadingInline.style.placeItems = "center"; }
      if (btn && btnText && btnSpin) {
        btn.setAttribute("disabled", "disabled");
        qInput?.setAttribute("readonly", "readonly");
        btnSpin.style.display = "inline-block";
        btnText.textContent = "Searching…";
      }
    }
    document.addEventListener("DOMContentLoaded", () => {
      const hasRows = !!document.querySelector("#resultsWrap tbody tr");
      if (hasRows) {
        if (loadingInline) loadingInline.style.display = "none";
        if (results) results.style.display = "block";
        if (btn && btnText && btnSpin) {
          btn.removeAttribute("disabled");
          qInput?.removeAttribute("readonly");
          btnSpin.style.display = "none";
          btnText.textContent = "Search";
        }
      }
    });
    form?.addEventListener("submit", () => { showInlineLoading(); });

    // ---------- Build data from table ----------
    const allRows = Array.from(document.querySelectorAll("#tableBody tr"));
    const data = allRows.map(tr => {
      const item = tr.querySelector(".c-item")?.textContent?.trim() || "";
      const vendor = tr.querySelector(".c-vendor")?.textContent?.trim() || "—";
      const priceText = tr.querySelector(".c-price")?.textContent || "0";
      const priceNum = Number(String(priceText).replace(/[^\d.-]/g,"")) || 0;
      return { item, vendor, price: priceNum };
    });

    // Populate vendor dropdown
    const vendorSelect = document.getElementById("vendorSelect");
    [...new Set(data.map(d => d.vendor).filter(Boolean))].sort().forEach(v => {
      const opt = document.createElement("option");
      opt.value = v; opt.textContent = v;
      vendorSelect.appendChild(opt);
    });

    // ---------- Filtering + Sorting + Pagination ----------
    const perPage = 10;
    const pagination = document.getElementById("pagination");
    const tbody = document.getElementById("tableBody");
    const filterInput = document.getElementById("filterInput");
    const minPrice = document.getElementById("minPrice");
    const maxPrice = document.getElementById("maxPrice");
    const clearBtn  = document.getElementById("clearFilters");
    let sortKey = null;
    let sortDir = 'asc';
    let currentPage = 1;

    function applyFilters() {
      const q = (filterInput.value || "").toLowerCase();
      const v = vendorSelect.value || "";
      const min = Number(minPrice.value || ""); const max = Number(maxPrice.value || "");
      return data.filter(d => {
        const qmatch = !q || d.item.toLowerCase().includes(q) || d.vendor.toLowerCase().includes(q);
        const vm = !v || d.vendor === v;
        const pm = (isNaN(min) || d.price >= min) && (isNaN(max) || (max===0 ? true : d.price <= max));
        return qmatch && vm && pm;
      });
    }

    function applySort(rows) {
      if (!sortKey) return rows;
      const sorted = [...rows].sort((a,b) => {
        let A = a[sortKey], B = b[sortKey];
        if (typeof A === 'string') { A = A.toLowerCase(); B = B.toLowerCase(); }
        if (A < B) return sortDir === 'asc' ? -1 : 1;
        if (A > B) return sortDir === 'asc' ? 1 : -1;
        return 0;
      });
      return sorted;
    }

    function render() {
      let rows = applyFilters();
      rows = applySort(rows);

      const pageCount = Math.max(1, Math.ceil(rows.length / perPage));
      if (currentPage > pageCount) currentPage = pageCount;

      // Render tbody
      tbody.innerHTML = "";
      const start = (currentPage - 1) * perPage;
      const slice = rows.slice(start, start + perPage);
      slice.forEach((d, idx) => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${start + idx + 1}</td>
          <td class="c-item">${d.item}</td>
          <td class="c-price">${idf.format(Math.round(d.price))}</td>
          <td class="c-vendor">${d.vendor}</td>`;
        tbody.appendChild(tr);
      });
      if (slice.length === 0) {
        const tr = document.createElement("tr");
        tr.innerHTML = `<td colspan="4" class="text-center text-muted py-4">Tidak ada data</td>`;
        tbody.appendChild(tr);
      }

      // Render pagination
      pagination.innerHTML = "";
      for (let i = 1; i <= pageCount; i++) {
        const li = document.createElement("li");
        li.className = "page-item" + (i === currentPage ? " active" : "");
        const a = document.createElement("a");
        a.className = "page-link"; a.href="#"; a.textContent = i;
        a.addEventListener("click", e => { e.preventDefault(); currentPage = i; render(); });
        li.appendChild(a); pagination.appendChild(li);
      }
    }

    // Header sorting
    document.querySelectorAll("th.th-sort").forEach(th => {
      th.addEventListener("click", () => {
        const key = th.getAttribute("data-key");
        if (sortKey === key) {
          sortDir = (sortDir === 'asc') ? 'desc' : 'asc';
        } else {
          sortKey = key; sortDir = 'asc';
        }
        document.querySelectorAll("th.th-sort").forEach(x => x.classList.remove("asc","desc"));
        th.classList.add(sortDir);
        currentPage = 1;
        render();
      });
    });

    // Filters events
    [filterInput, vendorSelect, minPrice, maxPrice].forEach(el => {
      el.addEventListener("input", () => { currentPage = 1; render(); });
      el.addEventListener("change", () => { currentPage = 1; render(); });
    });
    clearBtn.addEventListener("click", (e) => {
      e.preventDefault();
      filterInput.value = ""; vendorSelect.value = "";
      minPrice.value = ""; maxPrice.value = "";
      currentPage = 1; render();
    });

    // Initial render
    render();
  </script>
</body>
</html>